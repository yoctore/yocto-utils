<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/index.js - yocto-logger</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-logger" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/logger.html">logger</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var winston       = require(&#x27;winston&#x27;);
var _             = require(&#x27;lodash&#x27;);
var chalk         = require(&#x27;chalk&#x27;);
var moment        = require(&#x27;moment&#x27;);
var format        = require(&#x27;string-format&#x27;);
var uuid          = require(&#x27;uuid&#x27;);
var fs            = require(&#x27;fs&#x27;);
var path          = require(&#x27;path&#x27;);

// must extend String.prottype for use format to a method mode
format.extend(String.prototype);

// Allow to display errors
winston.emitErrs  = false;

/**
 * Yocto logger manager. Manage your own logger request
 *
 *
 * A custom logger wrapper based on winston for nodejs
 * 
 * For more details on these dependencies read links below :
 * - Winston : https://github.com/flatiron/winston
 * - LodAsh : https://lodash.com/
 * - Chalk : https://www.npmjs.com/package/chalk
 * - momentjs : http://momentjs.com/
 * - string-format : https://www.npmjs.com/package/string-format
 * - uuid : https://www.npmjs.com/package/uuid
 * - fs : https://nodejs.org/api/fs.html
 * - path : https://nodejs.org/api/path.html
 *
 * By default a console is configured with default options (cf winston documentation for more details)
 * Possibility to use the logger with these levels :
 *  - error
 *  - warning
 *  - info
 *  - debug
 *  - verbose
 *
 * A Banner function is available to display on console.log a more significant message.
 *
 * For each examples, please read file on example directory.
 *
 * @date : 21/04/2015
 * @author : Mathieu ROBERT &lt;mathieu@yocto.re&gt;
 * @copyright : Yocto SAS, All right reserved
 * @class logger
 */
function Logger() {

  /**
   * Default log level
   * @property logLevel
   * @type Integer
   * @default 5
   */
  this.logLevel                 = 5;
  
  /**
   * Default const to define console type
   * see : https://www.npmjs.com/package/winston#console-transport
   *
   * @property TYPE_CONSOLE
   * @type String
   * @default console
   */
  this.TYPE_CONSOLE             = &quot;console&quot;;

  /**
   * Default const to define daily rotate file 
   * see : https://www.npmjs.com/package/winston#daily-rotate-file-transport
   * 
   * @property TYPE_DAILY_ROTATE_FILE
   * @type String
   * @default console
   */
  this.TYPE_DAILY_ROTATE_FILE   = &quot;daily-rotate-file&quot;;
  
  /**
   * Default const to define error log level rules on current class
   * 
   * @property ERROR_LOG_LEVEL
   * @type Object
   */
  this.ERROR_LOG_LEVEL          = { name : &#x27;error&#x27;,   level : 1, f : &#x27;error&#x27;   };

  /**
   * Default const to define warning log level rules on current class
   * 
   * @property WARNING_LOG_LEVEL
   * @type Object
   */
  this.WARNING_LOG_LEVEL        = { name : &#x27;warning&#x27;, level : 2, f : &#x27;warn&#x27;    };

  /**
   * Default const to define info log level rules on current class
   * 
   * @property INFO_LOG_LEVEL
   * @type Object
   */  
  this.INFO_LOG_LEVEL           = { name : &#x27;info&#x27;,    level : 3, f : &#x27;info&#x27;    };

  /**
   * Default const to define debug log level rules on current class
   * 
   * @property DEBUG_LOG_LEVEL
   * @type Object
   */
  this.DEBUG_LOG_LEVEL          = { name : &#x27;debug&#x27;,   level : 4, f : &#x27;debug&#x27;   };

  /**
   * Default const to define verbose log level rules on current class
   * 
   * @property VERBOSE_LOG_LEVEL
   * @type Object
   */
  this.VERBOSE_LOG_LEVEL        = { name : &#x27;verbose&#x27;, level : 5, f : &#x27;verbose&#x27; };
  

  /**
   * Default formatter. use all data to render the correct message format to the logger formatter
   *
   * @method formatter
   * @param {Object} default options to use
   * @param {Boolean} if truen enable colorize process, false otherwise
   * @return {String} the correct string to use on current transporter
   */  
  var transportFormatter = function(options, colorize) {        
    // setting up the colorize flag
    colorize = colorize || false;

    // build data to log
    var dataToLog = {
      level    : options.level,
      date     : _.isFunction(options.timestamp) ? options.timestamp() : (_.isNull(options.timestamp) ? null : moment().format()),
      message  : (!_.isUndefined(options.message) &amp;&amp; !_.isEmpty(options.message) ? options.message : &#x27;&#x27;),
      meta     : (!_.isUndefined(options.meta) &amp;&amp; Object.keys(options.meta).length ? JSON.stringify(options.meta) : &#x27;&#x27;)
    };

    if (_.has(options, &#x27;label&#x27;) &amp;&amp; _.isFunction(options.label)) {
      dataToLog.level = options.label(options.level.toLowerCase());      
    }
    
    if (_.has(options, &#x27;timestamp&#x27;) &amp;&amp; _.isFunction(options.timestamp)) {
      dataToLog.date =  options.timestamp();      
    }    

    // use colorize only on console mode
    if (colorize) {
      if (_.has(options, &#x27;colorize&#x27;) &amp;&amp; _.isFunction(options.colorize)) {
        // prepare value to use on logger
        colorize = options.colorize(options.level);
        
        dataToLog.level = chalk[colorize](&#x27;{}&#x27;.format(options.label(options.level.toLowerCase())));  
      }
    }

    // default format    
    var dformat  = &#x27;{level} :&#x27;;
    
    if (!_.isNull(dataToLog.date)) {
      dformat = [ &#x27;[{date}]&#x27;, dformat ].join(&#x27; &#x27;);
    }
    
    
    // check if we have message
    if (!_.isUndefined(dataToLog.message) &amp;&amp; !_.isEmpty(dataToLog.message)) {
      dformat = [ dformat, &#x27;{message}&#x27;].join(&#x27; &#x27;);
    }

    // check if we have meta
    if (!_.isUndefined(dataToLog.meta) &amp;&amp; !_.isEmpty(dataToLog.meta)) {
      dformat = [ dformat, &#x27;{meta}&#x27;].join(&#x27; &#x27;);
    }

    // returning the correct message format
    return dformat.format(dataToLog);
  };

  /**
   * Default function to get a current date format
   * 
   * @method timestamp
   * @return {String} formated string based on moment.js format
   */
  var timestampFormatter = function() {
    return moment().format(&quot;DD/MM/YYYY HH:mm:ss&quot;);
  };

  /**
   * Default label function to retrive the correct label to display on logger
   *
   * @method labelFormatter
   * @param {String} value to check
   * @return {String} the correct value to display
   */  
  var labelFormatter =  function(value) {
    var rules = [
      { info     : &#x27;info    &#x27;  },
      { warn     : &#x27;warning &#x27;  },
      { error    : &#x27;error   &#x27;  },
      { debug    : &#x27;debug   &#x27;  },
      { verbose  : &#x27;verbose &#x27;  }
    ];
    
    // get index 
    var index = _.findIndex(rules, value);

    // check and return a correct value
    if (index &gt;= 0) {
      return _.first(_.values(rules[index]));
    }

    // return correct value
    return value;
  };

  /**
   * Default function to colorize the log level with chalk
   * 
   * @method colorize
   * @param (String) current level to use
   * @return (String) current color to use on chalk
   */
  var colorizeFormatter  = function(level) {
    var rules = [
      { info     : &#x27;green&#x27;  },
      { warn     : &#x27;yellow&#x27; },
      { error    : &#x27;red&#x27;    },
      { debug    : &#x27;blue&#x27;   },
      { verbose  : &#x27;white&#x27;  }
    ];
    
    // get index 
    var index = _.findIndex(rules, level);

    // check and return a correct value
    if (index &gt;= 0) {
      return _.first(_.values(rules[index]));
    }

    // return default value
    return &#x27;white&#x27;;
  };

  /**
   * Default console formatter. use all data to render the correct message format to the logger formatter
   *
   * @method formatter
   * @param {Object} default options to use
   * @return {String} the correct string to use on current transporter
   */  
  this.consoleTransportFormatter = function(options) {
    return transportFormatter(options, true);
  };

  /**
   * Default daily rotate file formatter. use all data to render the correct message format to the logger formatter
   *
   * @method formatter
   * @param {Object} default options to use
   * @return {String} the correct string to use on current transporter
   */  
  this.dailyRotateFileTransportFormatter = function(options) {
    return transportFormatter(options, false);
  };

  /**
   * Default console transport
   *
   * @property defaultConsoleTransport
   * @type Object 
   */
  this.defaultConsoleTransport = {
    level             : &#x27;verbose&#x27;,
    handleExceptions  : true,
    json              : false,
    showLevel         : true,
    silent            : false,
    label             : labelFormatter,
    formatter         : this.consoleTransportFormatter,
    timestamp         : null,
    colorize          : colorizeFormatter
  };

  /**
   * Default daily rotate transport file
   *
   * @property defaultDailyRotateTransportFile
   * @type Object 
   */
  this.defaultDailyRotateTransportFile = {
    name              : &#x27;default-daily-rotate-transport&#x27;,
    level             : &#x27;verbose&#x27;,
    dirname           : &#x27;./&#x27;,
    filename          : uuid.v4(),
    handleExceptions  : true,
    json              : false,
    maxsize           : 5242880,
    maxFiles          : 5,
    colorize          : true,
    datePattern       : &#x27;-yyyy-MM-dd.log&#x27;,
    label             : labelFormatter,
    formatter         : this.dailyRotateFileTransportFormatter,
    timestamp         : timestampFormatter   
  };
  
  /**
   * Default winston instance logger
   * 
   * @property winston
   * @type Object
   */
  this.winston = new (winston.Logger)({
    transports  : [ new (winston.transports.Console)(_.clone(this.defaultConsoleTransport)) ],
    exitOnError : false
  });  
}

/**
 * Adding transport on logger module
 * 
 * @method addTransport
 * @param {String} path to use
 * @param {String} filename to use
 * @param {Object} Override options on daily rotate
 */
Logger.prototype.addDailyRotateTransport = function(fullpath, filename, options) {
  
  // path is valid type ? transform to default value if not
  if (_.isUndefined(fullpath) || !_.isString(fullpath) || _.isNull(fullpath)) {
    fullpath = &#x27;./&#x27;;   
    this.warning(&#x27;[ Add New Daily Rotate Transport ] - Invalid path given. Using default path &quot;./&quot;&#x27;);
  }
  
  // normalize path
  fullpath = path.normalize(fullpath);
  fullpath = path.resolve(fullpath);
  
  // save current context
  var context = this;
  
  // check file 
  fs.lstat(fullpath, function(err, stats) {

    // is directory ?    
    if (!stats || !stats.isDirectory()) {
      context.error([ &#x27;[ Add New Daily Rotate Transport ] - Directory path : [&#x27;, fullpath, &#x27;] is invalid. Operation aborted !&#x27; ].join(&#x27; &#x27;));
    } else {
      // check permission
      fs.access(fullpath, fs.F_OK | fs.R_OK | fs.W_OK, function(err) {

        // can read / write ??? 
        if (err) {
          context.error([ &#x27;[ Add New Daily Rotate Transport ] - Cannot read and write on&#x27;, fullpath, &#x27; - operation aborted !&#x27; ].join(&#x27; &#x27;));     
        } else {
          // build object configuration
          var daily = _.clone(context.defaultDailyRotateTransportFile);
          
          // extend daily
          _.extend(daily, { dirname : fullpath });
          
          // is a valid options ?
          if (!_.isUndefined(options) &amp;&amp; !_.isNull(options) &amp;&amp; _.isObject(options)) {
            _.extend(daily, options);
          }
          
          // check if file is specified
          if (!_.isUndefined(filename) &amp;&amp; !_.isEmpty(filename) &amp;&amp; !_.isNull(filename)) {
            
            // is a valid file name 
            if (_.isString(filename) &amp;&amp; !_.isEmpty(filename)) {
              _.extend(daily, { filename : filename });              
            } else {
              context.warning([ &#x27;[ Add New Daily Rotate Transport ] - filename is not a string. retore filename to &#x27;, daily.filename ].join(&#x27; &#x27;));
            }
          }

          // winston is available ?? 
          if (!_.isUndefined(context.winston)) {
            // transport already exists ?
            if (_.has(context.winston.transports, daily.name)) {              
              context.warning([ &#x27;[ Add New Daily Rotate Transport ] - A transport with the name&#x27;, daily.name, &#x27;already exists. Removing current before adding new transport&#x27; ].join(&#x27; &#x27;));
              context.winston.remove(daily.name);
            }
            
            // add new
            context.winston.add(winston.transports.DailyRotateFile, daily);
            
            // build name for logging message
            filename = [ fullpath, daily.filename, moment().format(daily.datePattern.replace(&#x27;.log&#x27;, &#x27;&#x27;).toUpperCase()), &#x27;.log&#x27; ].join(&#x27;&#x27;);
            // log            
            context.info([ &#x27;[ Add New Daily Rotate Transport ] - Success ! Datas are logged in&#x27;, filename ].join(&#x27; &#x27;));

          } else {
            console.log(chalk.red(&#x27;[ Add New Daily Rotate Transport ] - Cannot add new transport. instance is invalid&#x27;));
          }
        }
      });
    }
  });
};

/**
 * Default process function, get the current level and log our own message and metdata
 *
 * @method process
 * @param (Integer), level, the current log level
 * @param (Mixed), messsagen the current message to display
 */
Logger.prototype.process = function(level, message, meta) {
  // Mixing all error object
  var all       = [ this.VERBOSE_LOG_LEVEL, this.INFO_LOG_LEVEL, this.WARNING_LOG_LEVEL, this.ERROR_LOG_LEVEL, this.DEBUG_LOG_LEVEL ];

  // setting up the max level to log
  var maxLevel  = this.logLevel || 5;

  // need a reference for test
  var ref       = maxLevel;

  // parse all log object to get the correct reference
  _.each(all, function(value, key, list) {
    if (_.isString(maxLevel)) {
      if (maxLevel === value.name) {
        ref = value.level;
      }
    }
  });

  // save the main scope to use it 
  var $this = this;

  // parse again and call the specific function
  _.each(all, function(value, key, list) {
    if (_.isNumber(ref)) {
      if (level &lt;= ref) {
        if (value.level == level) {
          if (!_.isUndefined(this.winston) &amp;&amp; !_.isNull(this.winston) &amp;&amp; _) {
            if (!_.isUndefined(meta)) {
              this.winston.log(value.f, message, meta);                
            } else {
              this.winston.log(value.f, message);              
            }            
          } else {
            console.log(chalk.red(&#x27;[ Logger.process ] - Cannot une winston logger. instance is undefined or null&#x27;));
          }
        }
      }
    }
  }, this);
};

/**
 * Log message and metadata with the current verbose level
 *
 * @method verbose
 * @param {String} message to send on logger
 * @param {Object} metadata to send on logger
 */
Logger.prototype.verbose = function(message, meta) {
  // call main log process with verbose level
  this.process(this.VERBOSE_LOG_LEVEL.level, message, meta);
};

/**
 * Log message and metadata with the current info level
 *
 * @method verbose
 * @param {String} message to send on logger
 * @param {Object} metadata to send on logger
 */
Logger.prototype.info = function(message, meta) {
  // call main log process with info level
  this.process(this.INFO_LOG_LEVEL.level, message, meta);
};

/**
 * Log message and metadata with the current warning level
 *
 * @method verbose
 * @param {String} message to send on logger
 * @param {Object} metadata to send on logger
 */
Logger.prototype.warning = function(message, meta) {
  // call main log process with warning level
  this.process(this.WARNING_LOG_LEVEL.level, message, meta);
};

/**
 * Log message and metadata with the current error level
 *
 * @method verbose
 * @param {String} message to send on logger
 * @param {Object} metadata to send on logger
 */
Logger.prototype.error = function(message, meta) {
    // call main log process with error level
  this.process(this.ERROR_LOG_LEVEL.level, message, meta);
};

/**
 * Log message and metadata with the current debug level
 *
 * @method verbose
 * @param {String} message to send on logger
 * @param {Object} metadata to send on logger
 */
Logger.prototype.debug = function(message, meta) {
    // call main log process with debug level
  this.process(this.DEBUG_LOG_LEVEL.level, message, meta);
};

/**
 * Log a banner message on console
 *
 * @method banner
 * @param {String} message to send on logger
 * @param {Object} cstyle style to use on banner based on chalk rules
 *
 * @example
 * 
 *      // eample with custom style
 *      instance.banner(&#x27;test message&#x27;, { color : &#x27;white&#x27;, bgColor : &#x27;bgRed&#x27; });
 *      // This will display &quot;test message&quot; with bgRed and white text 
 *  
 */
Logger.prototype.banner = function(message, cstyle) {
  // default style
  var style = {
    color           : &#x27;white&#x27;,
    bgColor         : &#x27;bgBlack&#x27;,
    topDelimiter    : &#x27;-&#x27;,
    bottomDelimiter : &#x27;-&#x27;,
    leftDelimiter   : &#x27;|&#x27;,
    rightDelimiter  : &#x27;|&#x27;        
  };

  // has custom style options with color and bgColor rules
  if (!_.isUndefined(cstyle) &amp;&amp; _.has(cstyle, &#x27;color&#x27;) &amp;&amp; _.has(cstyle, &#x27;bgColor&#x27;)) {

    // bg rules start by correct Prefix ?
    if (!_.startsWith(&#x27;bg&#x27;, cstyle.bgColor)) {
      cstyle.bgColor = [ &#x27;bg&#x27;, _.capitalize(cstyle.bgColor.toLowerCase()) ].join(&#x27;&#x27;);
    }

    // extend obj    
    _.extend(style, cstyle);
  }

  // build end message
  var endmessage  = [ style.leftDelimiter, message, style.rightDelimiter ].join(&#x27; &#x27;); 

  if (_.has(chalk.styles, style.color) &amp;&amp; _.has(chalk.styles, style.bgColor)) {
    // log full message
    console.log(chalk[style.color][style.bgColor](_.repeat(style.topDelimiter, endmessage.length)));  
    console.log(chalk[style.color][style.bgColor](endmessage));
    console.log(chalk[style.color][style.bgColor](_.repeat(style.bottomDelimiter, endmessage.length)));      
  } else {
      this.warning(&#x27;[ Logger.Banner ] - Cannot use custom style given style is invalid. please read chalk documentation. Logging with current shell config.&#x27;);  
      console.log(_.repeat(style.topDelimiter, endmessage.length));  
      console.log(endmessage);
      console.log(_.repeat(style.bottomDelimiter, endmessage.length));      
  }
};

/**
 * Export current logger to use it on node
 */
module.exports  = new (Logger)();

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
